class t{constructor(){this.children=new Map,this.isEnd=!1}getFirstBranch(){return function(e){let t="";for(;!e.isEnd;){const n=e.children.keys().next().value;t+=n,e=e.children.get(n)}return t}(this)}getSuffixes(){const e=[];return function t(n,s){n.isEnd&&e.push(s);for(const[e,o]of n.children.entries())t(o,s+e)}(this,""),e}}class e{constructor(){this.root=new t}set(e){let n=this.root;for(let s=0;s<e.length;s++){const o=e[s];n.children.has(o)||n.children.set(o,new t),n=n.children.get(o)}n.isEnd=!0}get(e){let t=this.root;for(let n=0;n<e.length;n++){const s=e[n];if(!t.children.has(s))return null;t=t.children.get(s)}return t}}class i{get inputedHiragana(){let e="";for(let t=0;t<this.laticeIndex;t++)e+=this.latice[t].hiragana;if(e.endsWith("っ")){const t=this.inputedRomaji.match(i.hatsuonRegexp)[0].length;e=e.replace(i.hatsuonRegexp,"っ".repeat(t-1))}return e}get remainedRomaji(){const e=this.currentNode;return(e?e.getFirstBranch():"")+this.latice.slice(this.laticeIndex+1).map(e=>e.root.getFirstBranch()).join("")}get remainedHiragana(){return this.hiragana.slice(this.inputedHiragana.length)}constructor(e,t={}){this.hiragana=e,this.options=t||{},this.options.shortSokuon=t.shortSokuon??!0,this.options.shortHatsuon=t.shortHatsuon??!0,this.latice=this.toLatice(e),this.laticeIndex=0,this.currentNode=this.latice[0].root,this.inputedRomaji=""}toLatice(e){const t=[];return e.match(i.wordRegexp).forEach(e=>{if(e.match(i.hiraganaRegexp)){const n=this.toHiraganaLatice(e);t.push(...n)}else{const n=this.toAsciiLatice(e);t.push(...n)}}),t}toAsciiLatice(t){const n=[];return Array.from(t).forEach(t=>{const s=new e;s.set(t),n.push(s)}),n}toHiraganaLatice(t){const n=[],s=t.match(i.segmentRegexp);for(const t of s){const o=t.lastIndexOf("っ");if(t.length>1&&o>=0){const s=t.slice(o+1);if(this.options.shortSokuon&&s.length>0){const t=new e;t.hiragana=s,this.getRomajiPattern(s).forEach(e=>{t.set(e)});const a=Array.from(t.root.children.keys());for(let r=0;r<=o;r++){const t=new e;t.hiragana="っ",s[0].match(i.nagyoRegexp)||a.forEach(e=>{t.set(e)}),this.getRomajiPattern("っ").forEach(e=>{t.set(e)}),n.push(t)}n.push(t)}else for(let s=0;s<=o;s++){const t=new e;t.hiragana="っ",this.getRomajiPattern("っ").forEach(e=>{t.set(e)}),n.push(t)}}else{const s=new e;s.hiragana=t,this.getRomajiPattern(t).forEach(e=>{s.set(e)}),n.push(s)}}return n}input(e){if(!this.currentNode)return!1;const t=this.currentNode.children.get(e);if(t)return t.isEnd?(this.laticeIndex+=1,this.laticeIndex>=this.latice.length?this.currentNode=null:this.currentNode=this.latice[this.laticeIndex].root):this.currentNode=t,this.inputedRomaji+=e,!0;switch(this.latice[this.laticeIndex].hiragana){case"ん":{if(!this.options.shortHatsuon)return!1;if(!this.inputedRomaji.at(-1).match(/[xn]/))return!1;if(e.match(/[aiueoy]/))return!1;if(this.laticeIndex+1>=this.latice.length)return!1;const t=this.latice[this.laticeIndex+1].root.children.get(e);return!!t&&(this.laticeIndex+=1,this.currentNode=t,this.inputedRomaji+=e,!0)}case"っ":{if(!this.options.shortSokuon)return!1;if(this.inputedRomaji.at(-1)!==e)return!1;if(e.match(/[aiueon]/))return!1;if(this.laticeIndex+1>=this.latice.length)return!1;const t=this.latice[this.laticeIndex+1].root.children.get(e);return!!t&&(this.laticeIndex+=1,this.currentNode=t,this.inputedRomaji+=e,!0)}}return!1}isEnd(){return!this.currentNode}getCombinations(e,t=[]){if(t.length===e.length)return[t.join("")];const n=[];for(const s of e[t.length])n.push(...this.getCombinations(e,[...t,s]));return n}get2gramPattern(e){const s=i.table[e[0]],n=i.table[e[1]],t=this.getCombinations([s,n]);if("っ"===e[0]){if(i.nagyoRegexp.test(e[1]))return t;{const e=n.map(e=>e[0]+e);return e.push(...t),e}}{const n=i.table[e]||[];return n.push(...t),n}}get3gramPattern(e){const s=i.table[e[0]],o=i.table[e[1]],a=i.table[e[2]],t=i.table[e.slice(1)],n=t?this.getCombinations([s,t]):[],r=this.getCombinations([s,o,a]);if(i.nagyoRegexp.test(e[1]))return n.push(...r),n;{const e=t?t.map(e=>e[0]+e):[],s=o.map(e=>e[0]+e),i=this.getCombinations([s,a]);return e.push(...i),e.push(...n),e.push(...r),e}}getRomajiPattern(e){switch(e.length){case 1:return i.table[e];case 2:return this.get2gramPattern(e);case 3:return this.get3gramPattern(e);default:throw new Error("parse error")}}}Object.defineProperty(i,"wordRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/([ぁ-ゖー]+|[ -~]+)/g}),Object.defineProperty(i,"hiraganaRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/[ぁ-ゖー]+/g}),Object.defineProperty(i,"segmentRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/っ*[ぁ-ゖー][ぁぃぅぇぉゃゅょ]?/g}),Object.defineProperty(i,"nagyoRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/[なにぬねのん]/}),Object.defineProperty(i,"hatsuonRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/(.)\1*$/}),Object.defineProperty(i,"table",{enumerable:!0,configurable:!0,writable:!0,value:{"ー":["-"],"いぇ":["ye"],"うぁ":["wha"],"うぃ":["wi","whi"],"うぇ":["we","whe"],"うぉ":["who"],"ゔぁ":["va"],"ゔぃ":["vi","vyi"],"ゔぇ":["ve","vye"],"ゔぉ":["vo"],"ゔゃ":["vya"],"ゔゅ":["vyu"],"ゔょ":["vyo"],"きゃ":["kya"],"きぃ":["kyi"],"きゅ":["kyu"],"きぇ":["kye"],"きょ":["kyo"],"ぎゃ":["gya"],"ぎぃ":["gyi"],"ぎゅ":["gyu"],"ぎぇ":["gye"],"ぎょ":["gyo"],"くぁ":["kwa","qa"],"くぃ":["kwi","qi"],"くぅ":["kwu"],"くぇ":["kwe","qe"],"くぉ":["kwo","qo"],"くゃ":["qya"],"くゅ":["qyu"],"くょ":["qyo"],"ぐぁ":["gwa"],"ぐぃ":["gwi"],"ぐぅ":["gwu"],"ぐぇ":["gwe"],"ぐぉ":["gwo"],"しゃ":["sha","sya"],"しぃ":["syi"],"しゅ":["shu","syu"],"しぇ":["she","sye"],"しょ":["sho","syo"],"じゃ":["ja","jya","zya"],"じぃ":["jyi","zyi"],"じゅ":["ju","jyu","zyu"],"じぇ":["je","jye","zye"],"じょ":["jo","jyo","zyo"],"すぁ":["swa"],"すぃ":["swi"],"すぅ":["swu"],"すぇ":["swe"],"すぉ":["swo"],"ちゃ":["cha","cya","tya"],"ちぃ":["cyi","tyi"],"ちゅ":["chu","cyu","tyu"],"ちぇ":["che","cye","tye"],"ちょ":["cho","cyo","tyo"],"ぢゃ":["dya"],"ぢぃ":["dyi"],"ぢゅ":["dyu"],"ぢぇ":["dye"],"ぢょ":["dyo"],"つぁ":["tsa"],"つぃ":["tsi"],"つぇ":["tse"],"つぉ":["tso"],"てゃ":["tha"],"てぃ":["thi"],"てゅ":["thu"],"てぇ":["the"],"てょ":["tho"],"でゃ":["dha"],"でぃ":["dhi"],"でゅ":["dhu"],"でぇ":["dhe"],"でょ":["dho"],"とぁ":["twa"],"とぃ":["twi"],"とぅ":["twu"],"とぇ":["twe"],"とぉ":["two"],"どぁ":["dwa"],"どぃ":["dwi"],"どぅ":["dwu"],"どぇ":["dwe"],"どぉ":["dwo"],"にゃ":["nya"],"にぃ":["nyi"],"にゅ":["nyu"],"にぇ":["nye"],"にょ":["nyo"],"ひゃ":["hya"],"ひぃ":["hyi"],"ひゅ":["hyu"],"ひぇ":["hye"],"ひょ":["hyo"],"びゃ":["bya"],"びぃ":["byi"],"びゅ":["byu"],"びぇ":["bye"],"びょ":["byo"],"ぴゃ":["pya"],"ぴぃ":["pyi"],"ぴゅ":["pyu"],"ぴぇ":["pye"],"ぴょ":["pyo"],"ふぁ":["fa","fwa","hwa"],"ふぃ":["fi","fwi","fyi","hwi"],"ふぅ":["fwu"],"ふぇ":["fe","fwe","fye","hwe"],"ふぉ":["fo","fwo","hwo"],"ふゃ":["fya"],"ふゅ":["fyu"],"ふょ":["fyo"],"みゃ":["mya"],"みぃ":["myi"],"みゅ":["myu"],"みぇ":["mye"],"みょ":["myo"],"りゃ":["rya"],"りぃ":["ryi"],"りゅ":["ryu"],"りぇ":["rye"],"りょ":["ryo"],"あ":["a"],"い":["i"],"う":["u","whu","wu"],"え":["e"],"お":["o"],"か":["ka","ca"],"き":["ki"],"く":["ku","cu","qu"],"け":["ke"],"こ":["ko","co"],"さ":["sa"],"し":["shi","si","ci"],"す":["su"],"せ":["se","ce"],"そ":["so"],"た":["ta"],"ち":["chi","ti"],"つ":["tsu","tu"],"て":["te"],"と":["to"],"な":["na"],"に":["ni"],"ぬ":["nu"],"ね":["ne"],"の":["no"],"は":["ha"],"ひ":["hi"],"ふ":["fu","hu"],"へ":["he"],"ほ":["ho"],"ま":["ma"],"み":["mi"],"む":["mu"],"め":["me"],"も":["mo"],"や":["ya"],"ゆ":["yu"],"よ":["yo"],"ら":["ra"],"り":["ri"],"る":["ru"],"れ":["re"],"ろ":["ro"],"わ":["wa"],"を":["wo"],"ん":["nn","xn"],"ぁ":["xa","la"],"ぃ":["xi","li","xyi","lyi"],"ぅ":["xu","lu"],"ぇ":["xe","le","xye","lye"],"ぉ":["xo","lo"],"ゃ":["xya","lya"],"ゅ":["xyu","lyu"],"ょ":["xyo","lyo"],"ゕ":["xka","lka"],"ゖ":["xke","lke"],"っ":["xtu","xtsu","ltu","ltsu"],"ゎ":["xwa","lwa"],"が":["ga"],"ぎ":["gi"],"ぐ":["gu"],"げ":["ge"],"ご":["go"],"ざ":["za"],"じ":["ji","zi"],"ず":["zu"],"ぜ":["ze"],"ぞ":["zo"],"だ":["da"],"ぢ":["di"],"づ":["du"],"で":["de"],"ど":["do"],"ば":["ba"],"び":["bi"],"ぶ":["bu"],"べ":["be"],"ぼ":["bo"],"ぱ":["pa"],"ぴ":["pi"],"ぷ":["pu"],"ぺ":["pe"],"ぽ":["po"],"ゐ":["wyi"],"ゑ":["wye"],"ゔ":["vu"]}});const remSize=parseInt(getComputedStyle(document.documentElement).fontSize),gamePanel=document.getElementById("gamePanel"),playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),aaOuter=document.getElementById("aaOuter"),startButton=document.getElementById("startButton"),romaNode=document.getElementById("roma"),gradeOption=document.getElementById("gradeOption"),aa=document.getElementById("aa"),tmpCanvas=document.createElement("canvas"),aiueo="あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん",aiueoRoma="a|i|u|e|o|ka,ca|ki|ku,cu|ke|ko,co|sa|si,shi,ci|su|se,ce|so|ta|ti,chi|tu,tsu|te|to|na|ni|nu|ne|no|ha|hi|hu,fu|he|ho|ma|mi|mu|me|mo|ya|yu|yo|ra|ri|ru|re|ro|wa|wo|nn,xn".split("|"),dakuon="がぎぐげござじずぜそだぢづでどばびぶべぼぱぴぷぺぽ",dakuonRoma="ga|gi|gu|ge|go|za|zi,ji|zu|ze|zo|da|di|du|de|do|ba|bi|bu|be|bo|pa|pi|pu|pe|po".split("|"),gameTime=120;let playing,countdowning,typeTimer;const bgm=new Audio("mp3/bgm.mp3");bgm.volume=.2,bgm.loop=!0;let errorCount=0,normalCount=0,solveCount=0,guide=!0,problemCount=25,problem;const layout109={default:["q w e r t y u i o p","a s d f g h j k l ;","z x c v b n m , ."],shift:["Q W E R T Y U I O P","A S D F G H J K L +","Z X C V B N M < >"]},simpleKeyboard=new SimpleKeyboard.default({layout:layout109,onKeyPress:e=>{typeEventKey(e)}}),audioContext=new AudioContext,audioBufferCache={};loadAudio("end","mp3/end.mp3"),loadAudio("keyboard","mp3/keyboard.mp3"),loadAudio("correct","mp3/correct.mp3"),loadAudio("incorrect","mp3/cat.mp3");let japaneseVoices=[];loadVoices(),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.play())}function toggleKeyboard(){const e=document.getElementById("virtualKeyboardOn"),t=document.getElementById("virtualKeyboardOff");e.classList.contains("d-none")?(e.classList.remove("d-none"),t.classList.add("d-none"),document.getElementById("keyboard").classList.remove("d-none"),resizeFontSize(aa)):(e.classList.add("d-none"),t.classList.remove("d-none"),document.getElementById("keyboard").classList.add("d-none"),document.getElementById("guideSwitch").checked=!1,guide=!1,resizeFontSize(aa))}function toggleGuide(e){e.target.checked?guide=!0:guide=!1}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}});e.then(e=>{japaneseVoices=e.filter(e=>e.lang=="ja-JP")})}function loopVoice(e,t){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.voice=japaneseVoices[Math.floor(Math.random()*japaneseVoices.length)],n.lang="ja-JP";for(let e=0;e<t;e++)speechSynthesis.speak(n)}function nextProblem(){playAudio("correct",.3),solveCount+=1,typable()}function removeGuide(e){e==" "&&(e="{space}");const t=simpleKeyboard.getButtonElement(e);if(t)t.classList.remove("guide"),simpleKeyboard.setOptions({layoutName:"default"});else{const e=simpleKeyboard.getButtonElement("{shift}");e&&e.classList.remove("guide")}}function showGuide(e){e==" "&&(e="{space}");const t=simpleKeyboard.getButtonElement(e);if(t)t.classList.add("guide");else{const e=simpleKeyboard.getButtonElement("{shift}");e&&e.classList.add("guide")}}function typeEvent(e){switch(e.code){case"Space":e.preventDefault();default:return typeEventKey(e.key)}}function typeEventKey(e){switch(e){case"Escape":startGame();return;case" ":if(!playing){startGame();return}}if(e.length==1){e=e.toLowerCase();const t=problem.romaji,n=t.currentNode,s=t.input(e);if(s){playAudio("keyboard"),normalCount+=1;const s=t.remainedRomaji,o=romaNode.children;o[0].textContent+=e,o[1].textContent=s[0],o[2].textContent=s.slice(1);for(const e of n.children.keys())removeGuide(e);t.isEnd()?nextProblem():guide&&showGuide(s[0])}else playAudio("incorrect",.3),errorCount+=1}}function resizeFontSize(e){function h(e,t){const n=tmpCanvas.getContext("2d");n.font=t;const s=n.measureText(e);return s.width}function f(e,t,n,s){const o=e.split(`
`),a=t+"px "+n;let i=0;for(let e=0;e<o.length;e++){const t=h(o[e],a);i<t&&(i=t)}return[i,t*o.length*s]}function m(e){const t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),n=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom);return[t,n]}const n=getComputedStyle(e),c=n.fontFamily,t=parseFloat(n.fontSize),l=parseFloat(n.lineHeight)/t,d=aaOuter.offsetHeight,u=infoPanel.clientWidth,i=[u,d],a=f(e.textContent,t,c,l),r=m(n),o=t*(i[0]-r[0])/a[0]*.9,s=t*(i[1]-r[1])/a[1]*.9;s<o?s<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=s+"px":o<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=o+"px"}function selectProblem(){switch(gradeOption.selectedIndex){case 0:case 2:return{yomi:aiueo[solveCount],roma:aiueoRoma[solveCount],romaji:new i(aiueo[solveCount])};case 1:return{yomi:aiueo[solveCount+25],roma:aiueoRoma[solveCount+25],yomiji:new i(aiueo[solveCount+25])};default:return{yomi:dakuon[solveCount],roma:dakuonRoma[solveCount],romaji:new i(dakuon[solveCount])}}}function typable(){if(solveCount>=problemCount)speechSynthesis.cancel(),clearInterval(typeTimer),bgm.pause(),playAudio("end"),scoring();else{const e=problem;if(problem=selectProblem(),aa.textContent=`${problem.yomi} ${problem.roma}`,loopVoice(problem.yomi,5),resizeFontSize(aa),guide){if(e){const t=e.romaji.currentNode;if(t)for(const e of t.children.keys())removeGuide(e)}showGuide(problem.roma[0])}}}function countdown(){if(countdowning)return;countdowning=!0,normalCount=errorCount=solveCount=0,document.getElementById("guideSwitch").disabled=!0,document.getElementById("virtualKeyboard").disabled=!0,gamePanel.classList.add("d-none"),countPanel.classList.remove("d-none"),counter.textContent=3;const e=setInterval(()=>{const t=document.getElementById("counter"),n=["skyblue","greenyellow","violet","tomato"];if(parseInt(t.textContent)>1){const e=parseInt(t.textContent)-1;t.style.backgroundColor=n[e],t.textContent=e}else countdowning=!1,playing=!0,clearInterval(e),document.getElementById("guideSwitch").disabled=!1,document.getElementById("virtualKeyboard").disabled=!1,gamePanel.classList.remove("d-none"),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),aaOuter.classList.remove("d-none"),scorePanel.classList.add("d-none"),resizeFontSize(aa),typable(),startTypeTimer(),localStorage.getItem("bgm")==1&&bgm.play(),startButton.disabled=!1},1e3)}function startGame(){clearInterval(typeTimer),initTime(),countdown(),countPanel.classList.remove("d-none"),scorePanel.classList.add("d-none")}function startTypeTimer(){const e=document.getElementById("time");typeTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(typeTimer),bgm.pause(),playAudio("end"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}gradeOption.addEventListener("change",e=>{initTime(),clearInterval(typeTimer);const t=[25,21,46,25];problemCount=t[e.target.selectedIndex]});function scoring(){playing=!1,infoPanel.classList.remove("d-none"),playPanel.classList.add("d-none"),aaOuter.classList.add("d-none"),countPanel.classList.add("d-none"),scorePanel.classList.remove("d-none");let e=parseInt(document.getElementById("time").textContent);e<120&&(e=gameTime-e);const t=(normalCount/e).toFixed(2);document.getElementById("totalType").textContent=normalCount+errorCount,document.getElementById("typeSpeed").textContent=t,document.getElementById("errorType").textContent=errorCount}resizeFontSize(aa),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("virtualKeyboard").onclick=toggleKeyboard,window.addEventListener("resize",()=>{resizeFontSize(aa)}),document.getElementById("guideSwitch").onchange=toggleGuide,startButton.addEventListener("click",startGame),document.addEventListener("keydown",typeEvent),document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})